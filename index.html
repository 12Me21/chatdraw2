<!doctype html><html lang=en-QS><meta charset=utf-8><meta name=viewport content="width=device-width, height=device-height, initial-scale=1" id=$meta_viewport>
<title>CHATDRAW 2!!!</title>

<script src=brush.js></script>

<style>
	body, html {
		background: aliceblue;
	}
	
	chat-draw {
		display: inline-grid;
		grid-template:
			"canvas" max-content
		"gap" 1px
		"controls" auto
		/ min-content;
		padding: 1px;
		--scale: 2;
		background: silver;
	}
	chat-draw canvas {
		grid-area: canvas;
		width: calc(var(--width) * 1px * var(--scale, 1));
		cursor: crosshair;
	}
	chat-draw form {
		/*margin-left: -1px;*/
		grid-area: controls;
		display: flex;
		flex-flow: row wrap;
	}
	chat-draw label {
		display: contents;
	}
	chat-draw input {
		display: none;
	}
	chat-draw b {
		display: block;
		box-sizing: border-box;
		flex: none;
		--cells: 1;
		width: calc(var(--scale) * 25px * var(--cells));
		height: calc(var(--scale) * 25px);
		
		appearance: none;
		margin: 0;
		padding: 0;
		border: 5px solid gray;
		border-color: #FFF #888 #666 #DDD;
		
		display: flex;
		align-items: center;
		justify-content: center;
	}
	
	chat-draw b {
		background: #BBB;
		color: #444;
		font-family: monospace;
	}
	chat-draw :disabled + b {
		border-color: #999;
		color: #666;
		background: #2929291A;
	}
	chat-draw b:hover {
		background: #DDD;
	}
	chat-draw :checked + b {
		border-color: #777 #555 #555 #777;
		box-shadow: 0 0 10px 0px inset black;
		color: #FFFF00A0;
		text-shadow: 0 0 1px red;
		background: #888;
		border-width: 0;
	}
	
	chat-draw input[type="range"] {
		--cells: 4;
	}
	button.icon {
		font-size: calc(var(--scale) * 16px);
	}
</style>

<chat-draw id=$chatdraw>
	<form autocomplete=off method=dialog></form>
</chat-draw>

<script>
	let chatdraw = new Drawer(300, 150)
	
	let od = [0, 8, 2, 10, 12, 4, 14, 6, 3, 11, 1, 9, 15, 7, 13, 5]
	let patterns = []
	// temporary canvas
	let pcanvas = document.createElement('canvas')
	pcanvas.width = 4
	pcanvas.height = 4
	let p2d = pcanvas.getContext('2d')
	//
	for (let i=0; i<16; i++) {
		let data = new ImageData(4, 4)
		for (let x=0; x<16; x++)
			if (od[x] <= i)
				// just set the alpha to 255, leave R,G,B as 0 (black) since the color doesn't matter
				data.data[x<<2|3] = 0xFF
		
		p2d.putImageData(data, 0, 0)
		let pattern = chatdraw.c2d.createPattern(pcanvas, 'repeat')
		patterns.push(pattern)
	}
	
	let brushes = []
	for (let d=1; d<=7; d++) {
		let r = d/2
		let origin = new Point(r, r)
		let fills = []
		for (let y=0; y<=d; y++) {
			for (let x=0; x<=d; x++) {
				if ((y-r-0.5)**2+(x-r-0.5)**2 <= r**2) {
					fills.push([x, y, -x*2+1, 1])
					break
				}
			}
		}
		brushes.push(new Brush(origin, fills))
	}
	
	let tools = {
		freehand: new Freehand(),
		slow: new Slow(),
		line: new LineTool(),
	}
	
	$chatdraw.prepend(chatdraw.canvas)
	
	let form = $chatdraw.lastElementChild
	
	// todo: group fields into sections
	// also todo: define the labels, actions, etc. of buttons in one place
	// and then their positions/insert them separately.
	let buttons = [
		{button:'clear', text:"reset"},
		{button:'undo', text:"↶"},
		{button:'redo', text:"↷"},
		
		{radio:'comp', text:"over", value:'source-over'},
		{radio:'comp', text:"behind", value:'destination-over'},
		{radio:'comp', text:"in", value:'source-atop'},
		{radio:'comp', text:"erase", value:'destination-out'},
		
		{radio:'color', text:"black", value:'#000000'},
		{radio:'color', text:"white", value:'#FFFFFF'},
		{radio:'color', text:"red", value:'#FF0000'},
		{radio:'color', text:"blue", value:'#0000FF'},
		
		{color:'pick', text:"■"},
		
		{radio:'tool', text:"pen", value:'freehand'},
		{radio:'tool', text:"slow", value:'slow'},
		{radio:'tool', text:"line", value:'line'},
	]
	brushes.forEach((b,i)=>{
		buttons.push({radio:'brush', text:"b"+i, value:i})
	})
	patterns.forEach((b,i)=>{
		buttons.push({radio:'pattern', text:"p"+i, value:i})
	})
	for (let b of buttons) {
		form.append(draw_button(b))
	}
	
	form.onchange = ev=>{
		let n = ev.target.name
		if (n=='color')
			chatdraw.set_color(ev.target.value)
		if (n=='comp')
			chatdraw.set_composite(ev.target.value)
		if (n=='pattern')
			chatdraw.set_pattern(patterns[+ev.target.value])
		if (n=='brush')
			chatdraw.set_brush(brushes[+ev.target.value])
		if (n=='tool')
			chatdraw.set_tool(tools[ev.target.value])
	}
	
	form.onclick = ev=>{
		let n = ev.target.name
		if (n=='clear')
			chatdraw.clear()
		
		if (n=='undo')
			chatdraw.history_do()
		if (n=='redo')
			chatdraw.history_do(true)
	}
	
	chatdraw.history_onchange = ()=>{
		form.undo.disabled = !chatdraw.history[0].length
		form.redo.disabled = !chatdraw.history[1].length
	}
	chatdraw.history_onchange()
	
	let make_cursor=(size=1)=>{
		let r = size/2+1 //  3->
		let svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="${r*2}" height="${r*2}">
<rect x="${r-0.5}" y="${r-0.5}" width="1" height="1"/>
<rect x="${0.5}" y="${0.5}" width="${r*2-1}" height="${r*2-1}" fill="none" stroke="red" stroke-width="1"/>
</svg>
		`
		let ox = r-0.5
		let oy = r-0.5
		let url = "data:image/svg+xml;base64,"+btoa(svg)
		
		chatdraw.canvas.style.cursor = `url("${url}") ${ox} ${oy}, crosshair`
	}
	
	make_cursor(3)
	
	//document.body.append(chatdraw.canvas)

	// aw why are we using ctx instead of c2d anymore..
	
</script>
<pre id=$log></pre>
